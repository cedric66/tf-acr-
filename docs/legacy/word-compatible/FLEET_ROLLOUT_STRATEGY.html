<!DOCTYPE html>
<html><head><meta charset="UTF-8">
<style>
body { font-family: "Calibri", "Arial", sans-serif; font-size: 11pt; line-height: 1.5; color: #000; max-width: 800px; margin: 20px auto; }
h1 { font-size: 24pt; color: #2E74B5; border-bottom: 2px solid #2E74B5; padding-bottom: 10px; margin-top: 24pt; }
h2 { font-size: 18pt; color: #2E74B5; margin-top: 18pt; }
h3 { font-size: 14pt; color: #1F4D78; margin-top: 14pt; }
h4 { font-size: 12pt; font-weight: bold; margin-top: 12pt; }
p { margin-bottom: 10pt; }
ul, ol { margin-bottom: 10pt; }
li { margin-bottom: 4pt; }
pre { font-family: "Consolas", "Courier New", monospace; font-size: 10pt; background-color: #f5f5f5; padding: 10px; border: 1px solid #ddd; white-space: pre-wrap; word-wrap: break-word; }
code { font-family: "Consolas", "Courier New", monospace; color: #c7254e; background-color: #f9f2f4; padding: 2px 4px; border-radius: 4px; }
pre code { background-color: transparent; color: inherit; padding: 0; }
.mermaid { border: 1px solid #007acc; background-color: #e6f7ff; padding: 15px; border-radius: 5px; margin: 10px 0; }
.mermaid-title { color: #007acc; font-weight: bold; font-family: sans-serif; margin-bottom: 5px; }
table { border-collapse: collapse; width: 100%; margin-bottom: 15px; }
th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
th { background-color: #f2f2f2; color: #333; }
blockquote { border-left: 4px solid #ddd; padding-left: 15px; color: #666; font-style: italic; }
</style>
</head><body>
<h1>Fleet Rollout Strategy: Spot Optimization for 300+ Clusters</h1>
<p><b>Target Scale:</b> 300+ AKS Clusters  </p>
<p><b>Scope:</b> Fleet-wide adoption of Spot Node Architecture  </p>
<p><b>Document Version:</b> 1.0</p>
<p>---</p>
<h2>‚ö†Ô∏è Critical Fleet Risks (The "Fail at Scale" Scenarios)</h2>
<h3>1. The "Spot Cannibalization" Effect</h3>
<p><b>Scenario:</b> </p>
<ul>
<li>You deploy this architecture to 300 clusters in <code>australiaeast</code>.</li>
<li>Suddenly, your own clusters demand 3,000+ spot nodes of <code>Standard_D4s_v5</code>.</li>
<li><b>Result:</b> You artificially spike the spot price or exhaust the capacity in that region. Your clusters start evicting <i>each other</i> or failing to scale.</li>
<p><b>Mitigation:</b></p>
<li><b>VM Diversity:</b> Enforce DIFFERENT spot VM sizes for different clusters (e.g., Cluster Set A uses <code>D4s</code>, Cluster Set B uses <code>E4s</code>).</li>
<li><b>Subscription Sharding:</b> Ensure clusters are spread across multiple Azure Subscriptions to avoid hitting the "Regional Spot vCPU Quota" (typically 2,000-10,000 vCPUs per subscription).</li>
</ul>
<h3>2. Simultaneous Regional Eviction (Global Outage)</h3>
<p><b>Scenario:</b> </p>
<ul>
<li>A major Azure capacity event occurs in <code>australiaeast</code>.</li>
<li>Azure reclaims spot capacity across the entire region.</li>
<li><b>Impact:</b> All 300 clusters lose their spot pools simultaneously.</li>
<li><b>Result:</b></li>
<li>Massive spike in standard node requests (3,000+ nodes).</li>
<li>Azure <b>Standard</b> allocation might fail due to sudden surge (AllocationFailed).</li>
<li>Your critical fallback mechanism fails because the cloud provider can't fulfill the standard fallback fast enough.</li>
<p><b>Mitigation:</b></p>
<li><b>Oversized Standard Pools:</b> Maintain a higher "minimum" standard count (buffer) on critical clusters.</li>
<li><b>Region Diversification:</b> If possible, enable DR clusters in <code>australiasoutheast</code> or paired regions.</li>
</ul>
<h3>3. Management Plane Saturation (ARM Throttling)</h3>
<p><b>Scenario:</b></p>
<ul>
<li>300 clusters autoscaling simultaneously (e.g., 9 AM login storm).</li>
<li>Thousands of <code>VirtualMachineScaleSet</code> API calls hit Azure Resource Manager.</li>
<li><b>Result:</b> HTTP 429 Throttling. Autoscalers hang. Nodes don't provision.</li>
<p><b>Mitigation:</b></p>
<li><b>Autoscaler Tuning:</b> Randomize <code>scan_interval</code> across the fleet (e.g., spread between 10s and 60s).</li>
</ul>
<p>---</p>
<h2>üó∫Ô∏è Rollout Strategy: The "Wave" Approach</h2>
<p><b>Do not deploy to all 300 clusters at once.</b> Use a 4-Wave approach.</p>
<h3>Wave 0: The "PoC" (Current State)</h3>
<ul>
<li><b>Scope:</b> 1 Non-Prod Cluster + 1 Prod Canary.</li>
<li><b>Goal:</b> Validate the architecture (templates, affinity rules).</li>
<li><b>Duration:</b> 2 Weeks.</li>
</ul>
<h3>Wave 1: "Development Fleet"</h3>
<ul>
<li><b>Scope:</b> All Dev/Test/Staging clusters (~100 clusters).</li>
<li><b>Goal:</b> Stress test Spot availability. "Cannibalization" check.</li>
<li><b>Safety:</b> PDBs enabled, but aggressive spot usage (100% capacity).</li>
<li><b>Duration:</b> 4 Weeks.</li>
</ul>
<h3>Wave 2: "Production Non-Critical"</h3>
<ul>
<li><b>Scope:</b> Production clusters for internal tools, batch processing (~50 clusters).</li>
<li><b>Goal:</b> Validate "Standard Fallback" in anger.</li>
<li><b>Safety:</b> Priority Expander enabled.</li>
<li><b>Duration:</b> 4 Weeks.</li>
</ul>
<h3>Wave 3: "Production Core" (The Big One)</h3>
<ul>
<li><b>Scope:</b> Business critical clusters (~150 clusters).</li>
<li><b>Strategy:</b> Broken into batches of 10 clusters per day.</li>
<li><b>Safety:</b> Detailed monitoring of "AllocationFailed" events.</li>
</ul>
<p>---</p>
<h2>üè∞ Governance & Policy (How to Manage 300 Clusters)</h2>
<p>You cannot manually check 300 clusters. You need <b>Azure Policy</b>.</p>
<h3>1. Enforce PDBs (Resilience)</h3>
<p>Create an Azure Policy to <b>Audit/Deny</b> any deployment that:</p>
<ul>
<li>Has <code>replicas > 1</code></li>
<li>But is MISSING a <code>PodDisruptionBudget</code>.</li>
<p><i>Reason: PDBs are the only thing saving you during mass eviction.</i></p>
</ul>
<h3>2. Enforce Anti-Affinity (Data Safety)</h3>
<p>Create an Azure Policy to <b>Deny</b> StatefulSets that do NOT have <code>nodeAffinity</code> excluding spot nodes.</p>
<p><i>Reason: Prevents a developer from accidentally deploying a database to a cheap spot node on Cluster #142.</i></p>
<h3>3. Enforce Terraform Module Version</h3>
<p>Use strict version pinning on your Terraform module source.</p>
<ul>
<li>Update fleet to <code>v1.0.1</code> -> Apply to Wave 1.</li>
<li>Verify -> Apply to Wave 2.</li>
</ul>
<p>---</p>
<h2>üìä Fleet Observability (Aggregated Metrics)</h2>
<p><b>Problem:</b> You cannot look at 300 Grafana dashboards.</p>
<p><b>Solution:</b> Build a "Fleet Health" Dashboard using Thanos/Cortex (Federated Prometheus) or Azure Monitor Workbooks.</p>
<p><b>Key Aggregate Metrics:</b></p>
<ol>
<li><b>Global Savings Rate:</b> Total $ saved across fleet.</li>
<li><b>Global Eviction Rate:</b> Are we seeing a regional storm? (Evictions > 1000/hour fleet-wide).</li>
<li><b>Fallback Rate:</b> % of clusters currently running on Standard fallback (indicates Spot exhaustion).</li>
</ol>
<p>---</p>
<h2>‚úÖ Checklist for 300-Cluster Success</h2>
<ol>
<li>[ ] <b>Quota Check:</b> tally up total vCPUs needed. Split across subscriptions to ensure quotas allow full fallback to Standard.</li>
<li>[ ] <b>Automation:</b> Ensure CI/CD pipelines can apply Terraform to batches of clusters (GitOps/ArgoCD).</li>
<li>[ ] <b>Governance:</b> Deploy Azure Policy to prevent "Stateful-on-Spot".</li>
<li>[ ] <b>Training:</b> Train the 50+ dev teams using these clusters on "Graceful Shutdown".</li>
</ol>
<p>---</p>
<p><b>Status:</b> Rollout Strategy Defined. Focus shifts from "Node Mechanics" to "Fleet Governance".</p>
</body></html>