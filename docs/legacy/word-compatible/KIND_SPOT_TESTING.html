<!DOCTYPE html>
<html><head><meta charset="UTF-8">
<style>
body { font-family: "Calibri", "Arial", sans-serif; font-size: 11pt; line-height: 1.5; color: #000; max-width: 800px; margin: 20px auto; }
h1 { font-size: 24pt; color: #2E74B5; border-bottom: 2px solid #2E74B5; padding-bottom: 10px; margin-top: 24pt; }
h2 { font-size: 18pt; color: #2E74B5; margin-top: 18pt; }
h3 { font-size: 14pt; color: #1F4D78; margin-top: 14pt; }
h4 { font-size: 12pt; font-weight: bold; margin-top: 12pt; }
p { margin-bottom: 10pt; }
ul, ol { margin-bottom: 10pt; }
li { margin-bottom: 4pt; }
pre { font-family: "Consolas", "Courier New", monospace; font-size: 10pt; background-color: #f5f5f5; padding: 10px; border: 1px solid #ddd; white-space: pre-wrap; word-wrap: break-word; }
code { font-family: "Consolas", "Courier New", monospace; color: #c7254e; background-color: #f9f2f4; padding: 2px 4px; border-radius: 4px; }
pre code { background-color: transparent; color: inherit; padding: 0; }
.mermaid { border: 1px solid #007acc; background-color: #e6f7ff; padding: 15px; border-radius: 5px; margin: 10px 0; }
.mermaid-title { color: #007acc; font-weight: bold; font-family: sans-serif; margin-bottom: 5px; }
table { border-collapse: collapse; width: 100%; margin-bottom: 15px; }
th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
th { background-color: #f2f2f2; color: #333; }
blockquote { border-left: 4px solid #ddd; padding-left: 15px; color: #666; font-style: italic; }
</style>
</head><body>
<h1>Kind Cluster Spot Simulation Testing</h1>
<blockquote><b>Document Purpose:</b> Document all Kind-based testing performed to validate Spot instance failure scenarios</blockquote>
<blockquote><b>Created:</b> 2026-01-20</blockquote>
<p>---</p>
<h2>Overview</h2>
<p>This document describes the local testing performed using <b>Kind (Kubernetes in Docker)</b> to simulate Spot instance behaviors and failure scenarios. Since Karpenter and Azure Spot APIs cannot run locally, we simulate the <i>behavior</i> and <i>effects</i> of Spot instances using node taints, cordons, and drains.</p>
<p>---</p>
<h2>Test Environments</h2>
<h3>Test 1: Basic Spot Simulation (<code>spot-sim</code>)</h3>
<p><b>Purpose:</b> Validate that workloads with spot tolerations schedule correctly and respond to node eviction.</p>
<p><b>Cluster Configuration:</b></p>
<pre class="yaml"><code>
nodes:

  - role: control-plane

  - role: worker                    # On-Demand (no taint)

  - role: worker

    labels:

      lifecycle: spot               # Simulated Spot Node

</code></pre>
<p><b>What Was Tested:</b></p>
<table>
<tr><td>Scenario</td><td>Description</td><td>Result</td></tr>
<tr><td>Spot Scheduling</td><td>Deploy pods with <code>tolerations</code> for spot taint</td><td>✅ Pods scheduled on spot-labeled node</td></tr>
<tr><td>Node Drain</td><td><code>kubectl drain</code> to simulate spot eviction</td><td>✅ Pods evicted successfully</td></tr>
<tr><td>Pending State</td><td>Pods cannot reschedule when only spot node available (cordoned)</td><td>✅ Pods entered Pending state</td></tr>
</table>
<p>---</p>
<h3>Test 2: Contention Simulation (<code>spot-contention-sim</code>)</h3>
<p><b>Purpose:</b> Simulate a multi-node environment with spot capacity exhaustion and fallback to on-demand.</p>
<p><b>Cluster Configuration:</b></p>
<pre class="yaml"><code>
nodes:

  - role: control-plane

  - role: worker

    labels:

      node-type: on-demand

      capacity-type: on-demand      # Always available

  - role: worker

    labels:

      node-type: spot

      capacity-type: spot

      sku-family: D                 # Simulated D-series VM

  - role: worker

    labels:

      node-type: spot

      capacity-type: spot

      sku-family: E                 # Simulated E-series VM

</code></pre>
<p><b>Workload Configuration:</b></p>
<ul>
<li><b>Replicas:</b> 6</li>
<li><b>Node Preference:</b> Spot (weight: 100), On-Demand fallback (weight: 50)</li>
<li><b>Topology Spread:</b> Distribute across nodes (<code>maxSkew: 1</code>)</li>
</ul>
<p>---</p>
<h2>Failure Scenarios Tested</h2>
<h3>Scenario 1: Spot Node Stockout</h3>
<p><b>What It Simulates:</b>  </p>
<p>Azure has no Spot capacity available for the requested VM SKU. New spot nodes cannot be provisioned.</p>
<p><b>How We Tested:</b></p>
<pre class="bash"><code>
# Cordon spot nodes (prevent new scheduling)

kubectl cordon spot-contention-sim-worker2

kubectl cordon spot-contention-sim-worker3

</code></pre>
<p><b>Expected Behavior:</b></p>
<ul>
<li>Existing pods on spot nodes continue running</li>
<li>New pods cannot schedule on spot nodes</li>
<li>New pods schedule on on-demand nodes (fallback)</li>
</ul>
<p><b>Actual Result:</b> ✅ <b>PASS</b>  </p>
<p>New pods routed to on-demand node when spot nodes cordoned.</p>
<p>---</p>
<h3>Scenario 2: Spot Eviction (2-Minute Warning)</h3>
<p><b>What It Simulates:</b>  </p>
<p>Azure reclaims Spot VMs with a 2-minute termination notice. All pods on the spot node must be evicted.</p>
<p><b>How We Tested:</b></p>
<pre class="bash"><code>
# Drain spot nodes (evict all pods)

kubectl drain spot-contention-sim-worker2 --ignore-daemonsets --delete-emptydir-data

kubectl drain spot-contention-sim-worker3 --ignore-daemonsets --delete-emptydir-data

</code></pre>
<p><b>Expected Behavior:</b></p>
<ul>
<li>Pods receive SIGTERM signal</li>
<li>Pods have <code>terminationGracePeriodSeconds</code> to shut down cleanly</li>
<li>Kubernetes creates replacement pods</li>
<li>Replacement pods schedule on available nodes</li>
</ul>
<p><b>Actual Result:</b> ✅ <b>PASS</b>  </p>
<p>All 6 pods evicted from spot nodes and rescheduled to on-demand node.</p>
<p>---</p>
<h3>Scenario 3: Complete Spot Capacity Failure</h3>
<p><b>What It Simulates:</b>  </p>
<p>All spot nodes in the cluster are unavailable (regional capacity event).</p>
<p><b>How We Tested:</b></p>
<pre class="bash"><code>
# Cordon AND drain all spot nodes

kubectl cordon spot-contention-sim-worker2

kubectl cordon spot-contention-sim-worker3

kubectl drain spot-contention-sim-worker2 --ignore-daemonsets --delete-emptydir-data --force

kubectl drain spot-contention-sim-worker3 --ignore-daemonsets --delete-emptydir-data --force

</code></pre>
<p><b>Expected Behavior:</b></p>
<ul>
<li>All spot pods evicted</li>
<li>Pods reschedule to on-demand nodes</li>
<li>If on-demand capacity insufficient → pods remain Pending</li>
</ul>
<p><b>Actual Result:</b> ✅ <b>PASS</b>  </p>
<ul>
<li>6 pods evicted from 2 spot nodes</li>
<li>6 pods rescheduled to 1 on-demand node</li>
<li>All pods Running (on-demand had sufficient capacity)</li>
</ul>
<p>---</p>
<h3>Scenario 4: Capacity Recovery</h3>
<p><b>What It Simulates:</b>  </p>
<p>Spot capacity becomes available again after a stockout.</p>
<p><b>How We Tested:</b></p>
<pre class="bash"><code>
# Uncordon spot nodes

kubectl uncordon spot-contention-sim-worker2

kubectl uncordon spot-contention-sim-worker3

</code></pre>
<p><b>Expected Behavior:</b></p>
<ul>
<li>Spot nodes become schedulable again</li>
<li>New pods can schedule on spot nodes</li>
<li>Existing pods on on-demand stay (no automatic migration)</li>
</ul>
<p><b>Actual Result:</b> ✅ <b>PASS</b>  </p>
<p>Nodes returned to <code>Ready</code> state and available for scheduling.</p>
<p>---</p>
<h3>Scenario 5: Topology Spread Validation</h3>
<p><b>What It Simulates:</b>  </p>
<p>Pods should spread across nodes to minimize blast radius of a single node failure.</p>
<p><b>How We Tested:</b></p>
<pre class="yaml"><code>
topologySpreadConstraints:

  - maxSkew: 1

    topologyKey: kubernetes.io/hostname

    whenUnsatisfiable: ScheduleAnyway

</code></pre>
<p><b>Expected Behavior:</b>  </p>
<p>With 6 pods and 3 worker nodes, expect ~2 pods per node.</p>
<p><b>Actual Result:</b> ✅ <b>PASS</b>  </p>
<p>Initial distribution: 2 pods on spot-worker2, 3 pods on spot-worker3, 1 pod on on-demand.</p>
<p>---</p>
<h2>Summary of Results</h2>
<table>
<tr><td>Scenario</td><td>Tested</td><td>Status</td></tr>
<tr><td>Spot Node Scheduling</td><td>✅</td><td>PASS</td></tr>
<tr><td>Spot Taint/Toleration</td><td>✅</td><td>PASS</td></tr>
<tr><td>Node Cordon (Stockout)</td><td>✅</td><td>PASS</td></tr>
<tr><td>Node Drain (Eviction)</td><td>✅</td><td>PASS</td></tr>
<tr><td>Fallback to On-Demand</td><td>✅</td><td>PASS</td></tr>
<tr><td>Topology Spread</td><td>✅</td><td>PASS</td></tr>
<tr><td>Capacity Recovery</td><td>✅</td><td>PASS</td></tr>
</table>
<p>---</p>
<h2>What Cannot Be Tested Locally</h2>
<table>
<tr><td>Feature</td><td>Reason</td><td>Alternative</td></tr>
<tr><td><b>Karpenter Auto-Provisioning</b></td><td>Requires Azure/AWS API</td><td>Use real cluster or mock APIs</td></tr>
<tr><td><b>Spot Pricing/Max Price</b></td><td>Azure billing feature</td><td>N/A</td></tr>
<tr><td><b>Real 2-Minute Warning</b></td><td>Azure Metadata Service</td><td>Use Azure Metadata proxy or generic metadata mock</td></tr>
<tr><td><b>Multi-Cluster Contention</b></td><td>Requires multiple real clusters</td><td>Test one cluster, extrapolate</td></tr>
<tr><td><b>VMSS Behavior</b></td><td>Azure infrastructure</td><td>Use AKS dev/test environment</td></tr>
</table>
<p>---</p>
<h2>How to Run Tests</h2>
<h3>Prerequisites</h3>
<ul>
<li>Docker</li>
<li>Kind (<code>go install sigs.k8s.io/kind@latest</code>)</li>
<li>kubectl</li>
</ul>
<h3>Run Full Simulation</h3>
<pre class="bash"><code>
cd /home/sp/Documents/code/tf-acr-



# Run the automated simulation script

./scripts/simulate_spot_contention.sh all

</code></pre>
<h3>Manual Testing</h3>
<pre class="bash"><code>
# Setup cluster

./scripts/simulate_spot_contention.sh setup



# Run simulation

./scripts/simulate_spot_contention.sh run



# Cleanup

./scripts/simulate_spot_contention.sh cleanup

</code></pre>
<p>---</p>
<h2>Related Files</h2>
<table>
<tr><td>File</td><td>Description</td></tr>
<tr><td><a href="../scripts/simulate_spot_contention.sh">simulate_spot_contention.sh</a></td><td>Automated test script</td></tr>
<tr><td><a href="../kind-config.yaml">kind-config.yaml</a></td><td>Basic Kind cluster config</td></tr>
<tr><td><a href="../spot-deployment.yaml">spot-deployment.yaml</a></td><td>Sample spot-tolerant deployment</td></tr>
<tr><td><a href="SCALED_SPOT_ORCHESTRATION.md">SCALED_SPOT_ORCHESTRATION.md</a></td><td>Architecture guide</td></tr>
</table>
<p>---</p>
<p><i>End of Document</i></p>
</body></html>