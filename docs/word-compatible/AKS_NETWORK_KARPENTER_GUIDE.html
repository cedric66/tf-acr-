<!DOCTYPE html>
<html><head><meta charset="UTF-8">
<style>
body { font-family: "Calibri", "Arial", sans-serif; font-size: 11pt; line-height: 1.5; color: #000; max-width: 800px; margin: 20px auto; }
h1 { font-size: 24pt; color: #2E74B5; border-bottom: 2px solid #2E74B5; padding-bottom: 10px; margin-top: 24pt; }
h2 { font-size: 18pt; color: #2E74B5; margin-top: 18pt; }
h3 { font-size: 14pt; color: #1F4D78; margin-top: 14pt; }
h4 { font-size: 12pt; font-weight: bold; margin-top: 12pt; }
p { margin-bottom: 10pt; }
ul, ol { margin-bottom: 10pt; }
li { margin-bottom: 4pt; }
pre { font-family: "Consolas", "Courier New", monospace; font-size: 10pt; background-color: #f5f5f5; padding: 10px; border: 1px solid #ddd; white-space: pre-wrap; word-wrap: break-word; }
code { font-family: "Consolas", "Courier New", monospace; color: #c7254e; background-color: #f9f2f4; padding: 2px 4px; border-radius: 4px; }
pre code { background-color: transparent; color: inherit; padding: 0; }
.mermaid { border: 1px solid #007acc; background-color: #e6f7ff; padding: 15px; border-radius: 5px; margin: 10px 0; }
.mermaid-title { color: #007acc; font-weight: bold; font-family: sans-serif; margin-bottom: 5px; }
table { border-collapse: collapse; width: 100%; margin-bottom: 15px; }
th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
th { background-color: #f2f2f2; color: #333; }
blockquote { border-left: 4px solid #ddd; padding-left: 15px; color: #666; font-style: italic; }
</style>
</head><body>
<h1>AKS Network Configuration & Karpenter Compatibility Guide</h1>
<blockquote><b>Updated:</b> January 2026</blockquote>
<blockquote><b>Purpose:</b> Network compatibility scenarios, migration paths, and cost analysis</blockquote>
<p>---</p>
<h2>Karpenter/NAP Status Update</h2>
<table>
<tr><td>Milestone</td><td>Date</td></tr>
<tr><td>Preview Launched</td><td>December 2023</td></tr>
<tr><td><b>General Availability</b></td><td><b>July 2025</b> ✅</td></tr>
<tr><td>Current Status</td><td><b>Production Ready</b></td></tr>
<blockquote>[!NOTE]</blockquote>
<blockquote>NAP is now GA. The <code>node_provisioning_mode</code> attribute should be available in azurerm provider 4.x releases after July 2025. Check for updates if your provider version doesn't support it.</blockquote>
<p>---</p>
<h2>Network Plugin Comparison Matrix</h2>
<table>
<tr><td>Feature</td><td>Kubenet</td><td>Azure CNI</td><td>Azure CNI Overlay</td><td>Azure CNI + Cilium</td></tr>
<tr><td><b>Pod IP Source</b></td><td>Internal NAT</td><td>VNet subnet</td><td>Private CIDR</td><td>Private CIDR + eBPF</td></tr>
<tr><td><b>VNet IP Usage</b></td><td>Low</td><td>High</td><td>Low</td><td>Low</td></tr>
<tr><td><b>Max Nodes</b></td><td>400</td><td>1000+</td><td>1000+</td><td>1000+</td></tr>
<tr><td><b>Windows Support</b></td><td>❌</td><td>✅</td><td>✅</td><td>❌</td></tr>
<tr><td><b>Network Policy</b></td><td>Calico only</td><td>Azure/Calico</td><td>Azure/Calico/Cilium</td><td>Cilium</td></tr>
<tr><td><b>Karpenter/NAP</b></td><td>❌</td><td>❌</td><td>⚠️ Requires Cilium</td><td>✅</td></tr>
<tr><td><b>Best For</b></td><td>Dev/Test</td><td>Enterprise VNet</td><td>Large clusters</td><td>Karpenter + observability</td></tr>
</table>
<p>---</p>
<h2>Karpenter Compatibility</h2>
<h3>✅ Supported Configuration</h3>
<pre class="bash"><code>
az aks create \

  --network-plugin azure \

  --network-plugin-mode overlay \

  --network-dataplane cilium

</code></pre>
<table>
<tr><td>Requirement</td><td>Value</td></tr>
<tr><td>Network Plugin</td><td>Azure CNI</td></tr>
<tr><td>Plugin Mode</td><td>Overlay</td></tr>
<tr><td>Data Plane</td><td>Cilium</td></tr>
<tr><td>Identity</td><td>System-assigned or User-assigned Managed Identity</td></tr>
<tr><td>Node OS</td><td>Linux only</td></tr>
<h3>❌ Incompatible Configurations</h3>
<table>
<tr><td>Configuration</td><td>Why Not Supported</td></tr>
<tr><td><b>Kubenet</b></td><td>No direct pod routing, UDR limits</td></tr>
<tr><td><b>Azure CNI (Traditional)</b></td><td>Requires Overlay mode</td></tr>
<tr><td><b>Calico</b></td><td>NAP requires Cilium</td></tr>
<tr><td><b>Windows Nodes</b></td><td>Not supported by Karpenter</td></tr>
<tr><td><b>IPv6</b></td><td>Not supported</td></tr>
<tr><td><b>Service Principal</b></td><td>Must use Managed Identity</td></tr>
</table>
<p>---</p>
<h2>Migration Scenarios</h2>
<h3>Scenario 1: Kubenet → Karpenter</h3>
<p><b>Current State:</b> Cluster using Kubenet  </p>
<p><b>Goal:</b> Enable Karpenter/NAP  </p>
<p><b>Path:</b> ⚠️ <b>Requires new cluster</b></p>
<div class="mermaid"><div class="mermaid-title">Mermaid Diagram (Copy text to Mermaid Live Editor)</div><pre>
graph LR

    A[Kubenet Cluster] --&gt;|Cannot upgrade| B{Decision}

    B --&gt;|Option 1| C[New Cluster with CNI Overlay + Cilium]

    B --&gt;|Option 2| D[Stay on Kubenet + Cluster Autoscaler]

    C --&gt; E[Enable NAP]

    C --&gt; F[Migrate Workloads]

</pre></div>
<p><b>Steps:</b></p>
<ol>
<li>Create new AKS cluster with Azure CNI Overlay + Cilium</li>
<li>Enable NAP: <code>az aks update -n <cluster> -g <rg> --node-provisioning-mode Auto</code></li>
<li>Migrate workloads using blue-green or canary deployment</li>
<li>Decommission old cluster</li>
</ol>
<p><b>Estimated Effort:</b> 2-4 weeks  </p>
<p><b>Risk:</b> Medium (workload migration required)</p>
<p>---</p>
<h3>Scenario 2: Azure CNI (Traditional) → Karpenter</h3>
<p><b>Current State:</b> Cluster using Azure CNI  </p>
<p><b>Goal:</b> Enable Karpenter/NAP  </p>
<p><b>Path:</b> ⚠️ <b>Requires new cluster</b></p>
<blockquote>[!WARNING]</blockquote>
<blockquote>You cannot upgrade network plugin mode in-place. A new cluster is required.</blockquote>
<p><b>Why Migration is Needed:</b></p>
<ul>
<li>Traditional Azure CNI assigns VNet IPs directly to pods</li>
<li>Overlay mode uses a separate pod CIDR</li>
<li>This is a fundamental architectural difference</li>
</ul>
<p><b>Steps:</b></p>
<ol>
<li>Create new cluster with <code>--network-plugin-mode overlay --network-dataplane cilium</code></li>
<li>Enable NAP</li>
<li>Migrate PVCs, ConfigMaps, Secrets</li>
<li>Update DNS/Load Balancers to point to new cluster</li>
</ol>
<p>---</p>
<h3>Scenario 3: Azure CNI Overlay → Karpenter</h3>
<p><b>Current State:</b> Cluster using Azure CNI Overlay (without Cilium)  </p>
<p><b>Goal:</b> Enable Karpenter/NAP  </p>
<p><b>Path:</b> ✅ <b>In-place upgrade possible</b></p>
<pre class="bash"><code>
# Upgrade data plane to Cilium

az aks update -n &lt;cluster&gt; -g &lt;rg&gt; --network-dataplane cilium



# Enable NAP

az aks update -n &lt;cluster&gt; -g &lt;rg&gt; --node-provisioning-mode Auto

</code></pre>
<p><b>Estimated Effort:</b> 1-2 hours  </p>
<p><b>Risk:</b> Low (brief control plane update)</p>
<p>---</p>
<h4>Technical Implications: Enabling Cilium on Azure CNI Overlay</h4>
<p>When upgrading from Azure CNI Overlay to Azure CNI Overlay + Cilium, understand these key changes:</p>
<h5>Pod CIDR / Subnet / VNet Impact</h5>
<table>
<tr><td>Aspect</td><td>Before (Overlay)</td><td>After (Overlay + Cilium)</td><td>Change Required</td></tr>
<tr><td><b>Pod CIDR</b></td><td><code>10.244.0.0/16</code> (default)</td><td>Same</td><td>❌ No change</td></tr>
<tr><td><b>VNet Subnet</b></td><td>Unchanged</td><td>Unchanged</td><td>❌ No change</td></tr>
<tr><td><b>Node Subnet</b></td><td>Unchanged</td><td>Unchanged</td><td>❌ No change</td></tr>
<tr><td><b>Service CIDR</b></td><td><code>10.0.0.0/16</code> (default)</td><td>Same</td><td>❌ No change</td></tr>
<blockquote>[!NOTE]</blockquote>
<blockquote><b>Good news:</b> Enabling Cilium does NOT change your pod CIDR, VNet, or subnet configuration. The overlay addressing remains the same.</blockquote>
<h5>What DOES Change</h5>
<table>
<tr><td>Component</td><td>Before</td><td>After</td><td>Impact</td></tr>
<tr><td><b>Data Plane</b></td><td>Azure native</td><td>Cilium eBPF</td><td>Performance improvement</td></tr>
<tr><td><b>kube-proxy</b></td><td>Running</td><td>Removed</td><td>Cilium handles service routing</td></tr>
<tr><td><b>Network Policy Engine</b></td><td>Azure NPM/Calico</td><td>Cilium</td><td>Policy behavior differences</td></tr>
<tr><td><b>Pod Networking</b></td><td>VXLAN encap</td><td>Cilium direct routing</td><td>Lower latency</td></tr>
<h5>Node Reimaging Process</h5>
<div class="mermaid"><div class="mermaid-title">Mermaid Diagram (Copy text to Mermaid Live Editor)</div><pre>
graph LR

    A[Start Upgrade] --&gt; B[Node Pool 1 Reimaged]

    B --&gt; C[Node Pool 2 Reimaged]

    C --&gt; D[Node Pool N Reimaged]

    D --&gt; E[Cilium Active on All Nodes]



    style B fill:#ff9,stroke:#333

    style C fill:#ff9,stroke:#333

    style D fill:#ff9,stroke:#333

</pre></div>
<blockquote>[!WARNING]</blockquote>
<blockquote><b>During upgrade:</b> Each node pool is reimaged (rolling). Expect:</blockquote>
<blockquote>- Pods rescheduled as nodes are drained</blockquote>
<blockquote>- ~5-10 minutes per node pool</blockquote>
<blockquote>- Brief temporary policy inconsistency until all nodes complete</blockquote>
<h5>Network Policy Compatibility</h5>
<p><b>Critical differences between Azure NPM and Cilium:</b></p>
<table>
<tr><td>Scenario</td><td>Azure NPM</td><td>Cilium</td><td>Action Needed</td></tr>
<tr><td><code>ipBlock</code> targeting Pod IPs</td><td>Allowed</td><td>❌ Blocked</td><td>Refactor to use <code>podSelector</code></td></tr>
<tr><td><code>ipBlock</code> targeting Node IPs</td><td>Allowed</td><td>❌ Blocked</td><td>Refactor to use <code>nodeSelector</code></td></tr>
<tr><td>Egress to local node IP</td><td>Implicitly allowed</td><td>❌ Blocked</td><td>Add explicit egress rule</td></tr>
<tr><td>Empty <code>podSelector</code></td><td>Matches all pods</td><td>Same</td><td>✅ No change</td></tr>
<tr><td>L7 policies</td><td>Not supported</td><td>Not supported (in AKS)</td><td>N/A</td></tr>
</table>
<p><b>Pre-migration checklist:</b></p>
<pre class="bash"><code>
# List all network policies

kubectl get networkpolicies -A



# Check for ipBlock rules (may need modification)

kubectl get networkpolicies -A -o yaml | grep -A5 &quot;ipBlock&quot;

</code></pre>
<h5>Example: Policy That Needs Modification</h5>
<p><b>Before (works with NPM, fails with Cilium):</b></p>
<pre class="yaml"><code>
apiVersion: networking.k8s.io/v1

kind: NetworkPolicy

metadata:

  name: allow-from-nodes

spec:

  podSelector: {}

  ingress:

    - from:

        - ipBlock:

            cidr: 10.224.0.0/16  # Node IP range - WON&#x27;T WORK

</code></pre>
<p><b>After (works with Cilium):</b></p>
<pre class="yaml"><code>
apiVersion: networking.k8s.io/v1

kind: NetworkPolicy

metadata:

  name: allow-from-nodes

spec:

  podSelector: {}

  ingress:

    - from:

        - namespaceSelector: {}  # Allow from any namespace

          podSelector: {}        # Any pod (including daemonsets on nodes)

</code></pre>
<h5>Verification Commands</h5>
<pre class="bash"><code>
# Check Cilium status

kubectl get pods -n kube-system -l k8s-app=cilium



# Verify no kube-proxy

kubectl get pods -n kube-system | grep kube-proxy  # Should return nothing



# Check network dataplane

az aks show -n &lt;cluster&gt; -g &lt;rg&gt; --query &quot;networkProfile.networkDataplane&quot;

</code></pre>
<h3>Scenario 4: Already on Azure CNI + Cilium</h3>
<p><b>Current State:</b> Cluster using Azure CNI Overlay + Cilium  </p>
<p><b>Goal:</b> Enable Karpenter/NAP  </p>
<p><b>Path:</b> ✅ <b>Simple enablement</b></p>
<pre class="bash"><code>
az aks update -n &lt;cluster&gt; -g &lt;rg&gt; --node-provisioning-mode Auto

</code></pre>
<p><b>Estimated Effort:</b> 15 minutes  </p>
<p><b>Risk:</b> Very Low</p>
<p>---</p>
<h2>Cost Analysis</h2>
<h3>Cilium Pricing</h3>
<table>
<tr><td>Tier</td><td>Cost</td><td>Features</td></tr>
<tr><td><b>Open Source</b></td><td><b>Free</b></td><td>eBPF networking, basic policy, kube-proxy replacement</td></tr>
<tr><td><b>Enterprise</b></td><td>~$600-1000/node/year</td><td>L7 policies, Hubble observability, enterprise support</td></tr>
<blockquote>[!TIP]</blockquote>
<blockquote>Azure CNI Powered by Cilium uses the <b>open-source</b> version at no additional cost. You only pay for underlying Azure infrastructure.</blockquote>
<h3>Karpenter (NAP) Pricing</h3>
<table>
<tr><td>Component</td><td>Cost</td></tr>
<tr><td><b>NAP Add-on</b></td><td><b>Free</b> (included in AKS)</td></tr>
<tr><td><b>Nodes Provisioned</b></td><td>Standard Azure VM pricing</td></tr>
<tr><td><b>Spot Nodes</b></td><td>60-90% discount</td></tr>
<h3>Total Cost Comparison (100-node cluster)</h3>
<table>
<tr><td>Configuration</td><td>Monthly Estimate</td><td>Notes</td></tr>
<tr><td>Cluster Autoscaler + Standard VMs</td><td>$15,000</td><td>Baseline</td></tr>
<tr><td>NAP + Spot VMs (70% spot)</td><td>$7,500</td><td>~50% savings via spot</td></tr>
<tr><td>NAP + Spot + Cilium Enterprise</td><td>$12,500</td><td>Observability but higher node cost</td></tr>
<h3>Cost Optimization Tips</h3>
<ol>
<li><b>Use Open-Source Cilium</b> - Enterprise features rarely needed for most workloads</li>
<li><b>Maximize Spot usage</b> - NAP's flexible SKU selection handles evictions better</li>
<li><b>Enable Consolidation</b> - NAP automatically consolidates underutilized nodes</li>
<li><b>Right-size pods</b> - Better bin-packing = fewer nodes needed</li>
</ol>
<p>---</p>
<h2>Decision Tree</h2>
<div class="mermaid"><div class="mermaid-title">Mermaid Diagram (Copy text to Mermaid Live Editor)</div><pre>
graph TD

    A[Current Network Config?] --&gt; B{Kubenet?}

    B --&gt;|Yes| C[New Cluster Required]

    B --&gt;|No| D{Azure CNI?}

    D --&gt;|Traditional| E[New Cluster Required]

    D --&gt;|Overlay| F{Has Cilium?}

    F --&gt;|No| G[Upgrade to Cilium]

    F --&gt;|Yes| H[Enable NAP]

    G --&gt; H

    C --&gt; I[Create with CNI Overlay + Cilium]

    I --&gt; H

    E --&gt; I

</pre></div>
<p>---</p>
<h2>Quick Reference Commands</h2>
<h3>Check Current Network Configuration</h3>
<pre class="bash"><code>
az aks show -n &lt;cluster&gt; -g &lt;rg&gt; --query &quot;networkProfile&quot;

</code></pre>
<h3>Create NAP-Compatible Cluster</h3>
<pre class="bash"><code>
az aks create \

  -n aks-nap-ready \

  -g rg-aks \

  --network-plugin azure \

  --network-plugin-mode overlay \

  --network-dataplane cilium \

  --node-provisioning-mode Auto

</code></pre>
<h3>Enable NAP on Existing Compatible Cluster</h3>
<pre class="bash"><code>
az aks update -n &lt;cluster&gt; -g &lt;rg&gt; --node-provisioning-mode Auto

</code></pre>
<h3>Verify NAP Status</h3>
<pre class="bash"><code>
kubectl get nodepools.karpenter.sh

kubectl get aksnodeclasses.karpenter.azure.com

</code></pre>
<p>---</p>
<h2>Related Documentation</h2>
<ul>
<li><a href="SCALED_SPOT_ORCHESTRATION.md">Scaled Spot Orchestration Guide</a></li>
<li><a href="AKS_SPOT_NODE_ARCHITECTURE.md">AKS Spot Node Architecture</a></li>
<li><a href="../terraform/prototypes/aks-nap/">Karpenter NAP Prototype</a></li>
</ul>
<p>---</p>
<p><i>Document created January 2026</i></p>
</body></html>