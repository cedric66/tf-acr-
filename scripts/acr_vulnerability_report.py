#!/usr/bin/env python3
"""
ACR Vulnerability Report
========================
Queries Microsoft Defender for Containers to find images with vulnerabilities.

Usage:
    python acr_vulnerability_report.py [--config config.json] [--subscription sub_id]
"""

import argparse
from azure.mgmt.containerregistry import ContainerRegistryManagementClient
from azure.mgmt.security import SecurityCenter
from tabulate import tabulate
from colorama import init, Fore, Style
import utils

init(autoreset=True)

def get_acr_assessments(security_client, acr_id):
    """Gets security assessments for an ACR from Defender."""
    try:
        # List assessments for the ACR resource
        # Defender for Containers uses assessment type: 
        # 'dbd0cb49-b563-45e7-9724-889e799fa648' for container vulnerabilities
        assessments = security_client.assessments.list(scope=acr_id)
        
        findings = []
        for assessment in assessments:
            if assessment.status and assessment.status.code == "Unhealthy":
                # This is a non-compliant assessment
                display_name = assessment.display_name or "Unknown"
                severity = assessment.metadata.severity if assessment.metadata else "Unknown"
                
                findings.append({
                    'name': display_name[:50],
                    'severity': severity,
                    'description': assessment.status.description[:100] if assessment.status.description else ""
                })
        
        return findings
        
    except Exception as e:
        utils.handle_azure_error(e, "Security Assessments", acr_id.split('/')[-1])
        return []

def severity_color(severity):
    """Color-codes severity levels."""
    sev_lower = severity.lower() if severity else ""
    if sev_lower == 'high':
        return f"{Fore.RED}{severity}{Style.RESET_ALL}"
    elif sev_lower == 'medium':
        return f"{Fore.YELLOW}{severity}{Style.RESET_ALL}"
    elif sev_lower == 'low':
        return f"{Fore.CYAN}{severity}{Style.RESET_ALL}"
    return severity

def main():
    parser = argparse.ArgumentParser(description="ACR Vulnerability Report")
    parser.add_argument("--config", help="Path to JSON config file")
    parser.add_argument("--subscription", help="Specific subscription ID")
    args = parser.parse_args()

    cred = utils.get_credential()
    config = utils.load_config(args.config) if args.config else None
    subs = utils.get_target_subscriptions(cred, config, args.subscription)

    data = []
    headers = ["ACR", "Finding", "Severity"]

    for sub in subs:
        try:
            acr_client = ContainerRegistryManagementClient(cred, sub.subscription_id)
            # Security Center client requires special handling for subscription scope
            security_client = SecurityCenter(cred, sub.subscription_id, "")
            
            registries = list(acr_client.registries.list())
            
            for acr in registries:
                findings = get_acr_assessments(security_client, acr.id)
                
                if findings:
                    for f in findings[:5]:  # Limit to top 5 per ACR
                        data.append([
                            acr.name,
                            f['name'],
                            severity_color(f['severity'])
                        ])
                else:
                    data.append([acr.name, f"{Fore.GREEN}No vulnerabilities found{Style.RESET_ALL}", "-"])

        except Exception as e:
            if not utils.handle_azure_error(e, "ACR Registries", f"Subscription: {sub.subscription_id}"):
                break
            continue

    if not data:
        print(f"{Fore.YELLOW}No ACRs found.{Style.RESET_ALL}")
    else:
        print(tabulate(data, headers=headers, tablefmt="grid"))
        print(f"\n{Fore.CYAN}Note:{Style.RESET_ALL} Requires Defender for Containers to be enabled.")

if __name__ == "__main__":
    main()
